---
import { getCollection, type CollectionEntry } from 'astro:content';
import { components } from '../components/componentMap';
import BaseLayout from '../layouts/BaseLayout.astro';
import DocsLayout from '../layouts/DocsLayout.astro';
import type { GetStaticPaths } from "astro";

// This is the new, simplified logic
export const getStaticPaths = (async () => {
  // Default language configuration
  const DEFAULT_LOCALE = 'en';
  
  const pages = await getCollection('pages');

  // Show docs in development and Cloudflare Pages preview deployments (staging)
  // Hide docs only in production builds
  const isDevelopment = import.meta.env.DEV;
  const isCloudflarePreview = import.meta.env.CF_PAGES_BRANCH && import.meta.env.CF_PAGES_BRANCH !== 'master';
  const showDocs = isDevelopment || isCloudflarePreview;

  const filteredPages = showDocs
    ? pages
    : pages.filter(entry => !entry.slug.includes('/docs'));

  const paths = [];

  for (const entry of filteredPages) {
    // entry.slug will be "en/index", "es/about", etc.
    // We need to remove "index" for root pages.
    const slug = entry.slug.endsWith('/index')
      ? entry.slug.slice(0, -'/index'.length)
      : entry.slug;

    // Always create the full path with language prefix (e.g., "en/videos", "es/videos")
    paths.push({
      params: { slug },
      props: { entry },
    });

    // For default language pages, also create routes without the language prefix
    if (entry.slug.startsWith(`${DEFAULT_LOCALE}/`)) {
      const slugWithoutLang = entry.slug.slice(DEFAULT_LOCALE.length + 1); // Remove "en/"
      const finalSlug = slugWithoutLang.endsWith('/index')
        ? slugWithoutLang.slice(0, -'/index'.length)
        : slugWithoutLang;

      // Only add non-empty slugs (videos, about, etc.) - empty means root "/"
      if (finalSlug) {
        paths.push({
          params: { slug: finalSlug },
          props: { entry },
        });
      }
    }
  }

  return paths;
}) satisfies GetStaticPaths;

// The entry contains the full data for the correct language
const { entry } = Astro.props as { entry: CollectionEntry<'pages'> };
const { data: pageData } = entry;
const { meta, content } = pageData;

// Check if this is a docs page
const isDocsPage = entry.slug.includes('/docs');

// Render the body content if it exists
const { Content } = await entry.render();
---

{isDocsPage ? (
  <DocsLayout title={meta.title} description={meta.description} entry={entry}>
    <Content />
  </DocsLayout>
) : (
  <BaseLayout title={meta.title} description={meta.description} image={meta.image}>
    <main>
      {content.map(block => {
        const Component = components[block.component] ?? components.fallback;

        return <Component {...block} />;
      })}
    </main>
  </BaseLayout>
)}
